\ProvidesPackage{internalsubfigures}[2024/02/09 v1.0 Jun's internal subfigure labeler]

\RequirePackage{subcaption}
\RequirePackage{etoolbox}


% ------ first pass, separate labels and captions -------

\newcommand{\internalsubfigurelabel}[1]{
  \begin{subfigure}[b]{0.001\textwidth}\caption{}
    \label{#1}
  \end{subfigure}
}

\renewcommand\thesubfigure{\Alph{subfigure}}
\DeclareCaptionLabelFormat{empty}{}
\captionsetup[subfigure]{labelformat=empty}


% ------ second pass, combine labels and captions -------

% % Define a new environment 'internalcaption'
\newenvironment{internalcaption}
  {% This code is executed at \begin{myenvironment}
   \resetlabellist % Reset the list at the beginning
   \resetcaptionlist
  }
  {% This code is executed at \end{myenvironment}
   %\par\noindent\textbf{Accumulated Content:}\par
   %\labellist % Use the accumulated content here
   %\captionlist % Use the accumulated content here
   \processinternallabels
   \caption{\processinternalcaption}

  }



% Command to add a new element to labellist and captionlist
\newcommand{\labellist}{}
\newcommand{\captionlist}{}
\newcommand{\themajorlabel}{}

% Command to add a new element to labellist and captionlist
\newcommand{\internalsubfigure}[2]{%
  \ifdefempty{\labellist}
    {\def\labellist{#1}}
    {\edef\labellist{\labellist,#1}} % Append with comma
  \ifdefempty{\captionlist}
    {\def\captionlist{#2}}
    {\edef\captionlist{\captionlist,#2}} % Append with comma
}

% Command to create a label for the entire figure.
\newcommand{\majorlabel}[1]{\def\themajorlabel{#1}}


% Command to clear the labellist and captionlist
\newcommand{\resetlabellist}{\renewcommand{\labellist}{}}
\newcommand{\resetcaptionlist}{\renewcommand{\captionlist}{}}
\newcommand{\resetmajorlabel}{\renewcommand{\themajorlabel}{}}

\newcommand{\processinternallabels}{%
    % Make the labels
  \renewcommand*\do[1]{%
    % This is where each item is actually processed
    \begin{subfigure}[b]{0.001\textwidth}\caption{}
      \label{##1}
    \end{subfigure}
  }
  \expandafter\docsvlist\expandafter{\labellist} 
} 

\newcommand{\processinternalcaption}{%
  % Make the captions
  % \caption{%
  \renewcommand*\do[1]{%
  % This is where each item is actually processed
    ##1
  }
  \expandafter\docsvlist\expandafter{\captionlist}
}




% --- third pass, custom figure environment ----

% Define the custom figure environment
\newenvironment{myfigure}[1][htbp]
  {% Begin code - executed at \begin{myfigure}
    \resetlabellist % Reset the list at the beginning
    \resetcaptionlist
    \resetmajorlabel
    \begin{figure}[#1]
    \centering % For example, centering all figures
  }
  {% End code - executed at \end{myfigure}
    \protect\processinternallabels
    %\processinternalcaption
    \caption{
      \protect\processinternalcaption
      \label{\themajorlabel}
    }
    %\caption{Hello from inside myfigure environment!}
    \end{figure}
  }
 
\endinput
